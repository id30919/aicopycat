<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒä¸»å¯© V33 (æ¸…é™¤ä¸‹ç·šåŠŸèƒ½)</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --color-left: #ff9800; 
            --color-right: #00b0ff; 
            --bg-dark: #222; 
            --score-size: 250px; 
            --header-height: 55px;
            --ui-element-height: 32px;
        }

        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: white; 
            height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        
        /* === Header === */
        #header { 
            height: var(--header-height); background: #333; display: flex; justify-content: space-between; align-items: center; padding: 0 5px; flex-shrink: 0; z-index: 100; 
            border-bottom: 1px solid #444;
            padding-left: 60px; 
        }
        
        .header-left { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 8px; white-space: nowrap; }

        .rainbow-input-group {
            display: flex; align-items: stretch; border-radius: 6px; overflow: hidden;
            height: var(--ui-element-height); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rainbow-label { 
            padding: 0 10px; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .rainbow-input { 
            border: none; color: white; padding: 0; height: 100%; text-align: center;
            font-weight: bold; font-size: 14px; outline: none; cursor: pointer;
            font-family: 'Segoe UI', sans-serif; user-select: none;
        }
        
        .theme-umpire .rainbow-label { background: #7b1fa2; }
        .theme-umpire .rainbow-input { background: #4a148c; width: 70px; }
        .theme-court .rainbow-label { background: #00796b; }
        .theme-court .rainbow-input { background: #004d40; width: 40px; }

        .btn-icon { 
            background: transparent; border: 1px solid #666; color: #ddd; 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:active { background: #555; }

        .live-switch {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            padding: 0 10px; border-radius: 20px; border: 1px solid #555; background: #111;
            height: var(--ui-element-height); box-sizing: border-box; transition: all 0.3s;
        }
        .live-switch.active { background: rgba(0, 200, 0, 0.2); border-color: #00ff00; }
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; transition: all 0.3s; }
        .live-switch.active .live-dot { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .live-text { font-size: 12px; color: #aaa; font-weight: bold; white-space: nowrap; }
        .live-switch.active .live-text { color: #fff; }

        @media (max-width: 480px) {
            #header { padding-left: 5px; padding-right: 5px; }
            .header-left { gap: 4px; }
            .rainbow-label { padding: 0 5px; font-size: 12px; }
            .theme-umpire .rainbow-input { width: 50px; font-size: 13px; }
            .theme-court .rainbow-input { width: 30px; font-size: 13px; }
            .live-text { display: none; }
            .live-switch { padding: 0 8px; }
            .header-right { gap: 4px; }
            .btn-icon { width: 30px; height: 30px; font-size: 14px; }
            #match-counter { font-size: 14px !important; margin-right: 0; }
        }

        /* Action Bar */
        #action-bar {
            height: 60px; background: #222; display: flex; justify-content: space-around; align-items: center; padding: 0 5px; flex-shrink: 0; z-index: 100;
            border-bottom: 2px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-act {
            flex: 1; margin: 0 3px; height: 44px; border-radius: 8px; border: none;
            color: white; font-weight: bold; font-size: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 3px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn-undo { background: #546e7a; }
        .btn-swap { background: #f57c00; } 
        .btn-log  { background: #43a047; }
        .btn-end  { background: #d32f2f; border: 1px solid #ff8a80; }

        /* Modal & Toast */
        #universal-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .u-modal-box { background: #333; padding: 25px; border-radius: 12px; border: 1px solid #555; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .u-modal-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #ffeb3b; }
        .u-modal-msg { font-size: 16px; color: #ddd; margin-bottom: 20px; line-height: 1.5; white-space: pre-wrap; }
        .u-modal-input { width: 100%; padding: 10px; margin-bottom: 20px; font-size: 18px; background: #222; color: white; border: 1px solid #666; border-radius: 5px; text-align: center; box-sizing: border-box; display: none; }
        .u-btn-group { display: flex; gap: 10px; justify-content: center; }
        .u-btn { flex: 1; padding: 12px; border-radius: 6px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
        .u-btn-cancel { background: #555; color: white; }
        .u-btn-confirm { background: #00c853; color: white; }

        #toast-msg {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 14px; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            border: 1px solid #555; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #toast-msg.show { opacity: 1; }

        /* Court Area */
        #court { 
            flex: 1; display: flex; position: relative; 
            overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        .side { 
            flex: 1; display: flex; flex-direction: column; 
            justify-content: space-between; align-items: center;
            position: relative; cursor: pointer; user-select: none; 
            transition: background-color 0.2s; padding: 15px 0; overflow: hidden; min-height: 300px;
        }
        .side.team-a { background-color: var(--color-left); } 
        .side.team-b { background-color: var(--color-right); }
        
        .score-bg-layer { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 0; width: 100%; text-align: center; opacity: 0.6; 
        }
        .score { 
            font-size: var(--score-size); font-weight: bold; line-height: 1; 
            pointer-events: none; transition: font-size 0.2s; text-shadow: 0 0 20px rgba(0,0,0,0.3); 
        }

        .team-name-wrapper { width: 100%; text-align: center; z-index: 10; min-height: 50px; }
        .team-name { font-size: 32px; font-weight: bold; pointer-events: auto; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        .bottom-info-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 10; min-height: 100px; justify-content: flex-end; }
        
        .server-indicator { 
            font-size: 18px; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; margin-bottom: 8px; 
            pointer-events: none; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.2s;
        }
        .side.serving .server-indicator { opacity: 1; }
        
        .position-box { 
            width: 92%; height: 60px; display: flex; border: 2px solid rgba(255,255,255,0.8); 
            background: rgba(0,0,0,0.4); pointer-events: auto; flex-shrink: 0;
            backdrop-filter: blur(2px); margin-bottom: 20px; 
        }
        .pos-l, .pos-r { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #fff; pointer-events: none; font-weight: bold; }
        .pos-active { background: rgba(255,255,255,0.95); color: #000; font-weight: bold; font-size: 22px; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        
        @keyframes click-flash { 0% { filter: brightness(1.5); } 100% { filter: brightness(1); } }
        .flash-active { animation: click-flash 0.1s ease-out; }

        #settings-panel, #history-panel { position: absolute; top: 115px; left: 0; width: 100%; height: calc(100% - 115px); background: #222; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; overflow-y: auto; }
        .panel-visible { display: block !important; }
        .full-width { width: 100%; box-sizing: border-box; font-size: 16px; padding: 10px; margin-bottom: 10px; background: #444; border: 1px solid #666; color: white; }
        .row { margin-bottom: 15px; } label { display: block; color: #aaa; margin-bottom: 5px; }
        .switch-row { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 10px; border-radius: 5px; border: 1px solid #555; margin-bottom: 15px; }
        .toggle-checkbox { width: 20px; height: 20px; cursor: pointer; }
        input[type=range] { width: 100%; margin: 10px 0; }
        
        .log-item { background: #333; margin-bottom: 10px; padding: 10px; border-radius: 5px; border: 1px solid #555; display: flex; justify-content: space-between; align-items: center; }
        .log-info { font-size: 14px; color: #ddd; }
        .log-status { font-size: 12px; margin-left: 10px; padding: 3px 8px; border-radius: 4px; }
        .status-pending { background: #555; color: #ccc; }
        .status-sending { background: #ff9800; color: #000; }
        .status-done { background: #4caf50; color: #fff; }
        .status-error { background: #f44336; color: #fff; }
    </style>
</head>
<body>

    <div id="toast-msg">âœ… æ“ä½œæˆåŠŸ</div>

    <div id="universal-modal">
        <div class="u-modal-box">
            <div id="u-modal-title" class="u-modal-title">æç¤º</div>
            <div id="u-modal-msg" class="u-modal-msg">å…§å®¹</div>
            <input type="text" id="u-modal-input" class="u-modal-input">
            <div class="u-btn-group">
                <button class="u-btn u-btn-cancel" onclick="closeUniversalModal()">å–æ¶ˆ</button>
                <button class="u-btn u-btn-confirm" id="u-modal-confirm-btn">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div id="header">
        <div class="header-left">
            <div class="rainbow-input-group theme-umpire" onclick="editUmpireName()">
                <div class="rainbow-label">ä¸»å¯©</div>
                <input type="text" id="umpireName" class="rainbow-input" placeholder="åŸéšçˆº" readonly>
            </div>
            <div class="rainbow-input-group theme-court" onclick="editCourtNum()">
                <div class="rainbow-label">å ´åœ°</div>
                <input type="number" id="courtNum" class="rainbow-input" value="1" readonly>
            </div>
        </div>
        
        <div class="header-right" style="display:flex; align-items:center; gap:8px;">
            <div class="live-switch" id="liveToggle" onclick="handleLiveClick()">
                <div class="live-dot"></div>
                <div class="live-text" id="liveText">é›¢ç·š</div>
            </div>
            <span id="match-counter" style="color:yellow; font-weight:bold; font-size:18px;">G1</span>
            <button class="btn-icon" onclick="toggleFullScreen()" title="å…¨è¢å¹•">â›¶</button>
            <button class="btn-icon" onclick="openSettings()">âš™</button>
            <button class="btn-icon" onclick="toggleHistory()">ğŸ“</button>
        </div>
    </div>

    <!-- Action Bar -->
    <div id="action-bar">
        <button class="btn-act btn-undo" onclick="undoPoint()">â†© å¾©åŸ</button>
        <button class="btn-act btn-swap" onclick="swapSidesManual()">â‡„ æ›é‚Š</button>
        <button class="btn-act btn-log" onclick="logGameOnly()">ğŸ’¾ ç´€éŒ„</button>
        <button class="btn-act btn-end" onclick="endMatchAndNext()">ğŸ çµæŸ</button>
    </div>

    <div id="court">
        <div id="area-left" class="side team-a">
            <div class="team-name-wrapper">
                <div class="team-name" id="name-box-left">æ©˜éšŠ</div>
            </div>
            <div class="score-bg-layer"><div class="score" id="disp-score-left">0</div></div>
            <div class="bottom-info-wrapper">
                <div class="server-indicator">ç™¼çƒ</div>
                <div class="position-box" id="pos-box-left">
                    <div class="pos-l" id="pos-l-left">å·¦å€</div>
                    <div class="pos-r" id="pos-r-left">å³å€</div>
                </div>
            </div>
        </div>

        <div id="area-right" class="side team-b">
            <div class="team-name-wrapper">
                <div class="team-name" id="name-box-right">è—éšŠ</div>
            </div>
            <div class="score-bg-layer"><div class="score" id="disp-score-right">0</div></div>
            <div class="bottom-info-wrapper">
                <div class="server-indicator">ç™¼çƒ</div>
                <div class="position-box" id="pos-box-right">
                    <div class="pos-l" id="pos-l-right">å·¦å€</div>
                    <div class="pos-r" id="pos-r-right">å³å€</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings-panel">
        <h3>æ¯”è³½è¨­å®š</h3>
        
        <div class="row">
            <button class="btn-act" onclick="safeConfirm('ç¢ºå®šè¦å°‡æ¯”åˆ†æ­¸é›¶å—ï¼Ÿ', resetGame)" style="background:#d32f2f; width:100%;">âš ï¸ æ­¸é›¶é‡ç½®</button>
        </div>

        <div class="switch-row">
            <label style="color:white; font-weight:bold; margin:0;">ğŸ“³ éœ‡å‹•å›é¥‹</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="doVibrate(500)" style="padding:2px 8px; background:#ff9800; border:none; border-radius:4px; color:white;">æ¸¬è©¦</button>
                <input type="checkbox" id="vibrationToggle" class="toggle-checkbox" checked onchange="toggleVibration(this.checked)">
            </div>
        </div>

        <div class="row" style="background:#333; padding:10px; border-radius:5px; border:1px solid #555;">
            <label style="color:#ffeb3b; font-weight:bold;">ğŸ”  åˆ†æ•¸å¤§å°: <span id="size-val">250</span>px</label>
            <input type="range" min="100" max="600" value="250" oninput="changeScoreSize(this.value)">
        </div>
        
        <div class="row"><label>Google Form é å¡«é€£çµ</label><input id="gform_link" class="full-width" placeholder="è²¼ä¸Šé€£çµ..."></div>
        <div class="row"><label>AéšŠåå–® (;åˆ†å ´æ¬¡)</label><input id="teamA_name" class="full-width" value="æ©˜éšŠ;æ©˜äºŒéšŠ"></div>
        <div class="row"><label>AéšŠå“¡ (ä¾‹å¦‚: ç‹,æ)</label><input id="teamA_players" class="full-width" value="ç‹,æ"></div>
        <div class="row"><label>BéšŠåå–® (;åˆ†å ´æ¬¡)</label><input id="teamB_name" class="full-width" value="è—éšŠ;è—äºŒéšŠ"></div>
        <div class="row"><label>BéšŠå“¡ (ä¾‹å¦‚: å¼µ,æ—)</label><input id="teamB_players" class="full-width" value="å¼µ,æ—"></div>
        <div class="row"><label>æ›é‚Šåˆ†æ•¸</label><input id="swapPoints" class="full-width" value="11"></div>
        <div class="row"><label>ç™¼çƒæ–¹</label><select id="initServer" class="full-width" onchange="resetGame()"><option value="A">AéšŠå…ˆç™¼</option><option value="B">BéšŠå…ˆç™¼</option></select></div>
        
        <!-- V33: æ–°å¢æ¸…é™¤æŒ‰éˆ• -->
        <div class="row" style="border-top:1px solid #555; margin-top:15px; padding-top:15px;">
            <button class="btn-act" onclick="clearCourtData()" style="background:#b71c1c; border:1px solid #ff5252; width:100%;">ğŸ—‘ï¸ æ¸…é™¤æ­¤å ´åœ° (ç›´æ’­ä¸‹ç·š)</button>
            <div style="font-size:12px; color:#aaa; margin-top:5px; text-align:center;">è©²å ´åœ°ä»Šå¤©æ¯”å®Œå¾Œè«‹æŒ‰æ­¤ï¼Œå°‡å¾ç›´æ’­ç‰†ç§»é™¤</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px; padding-bottom:20px;">
            <button class="btn-act" style="background:#555;" onclick="cancelSettings()">âœ– å–æ¶ˆ</button>
            <button class="btn-act" style="background:green;" onclick="saveSettings()">âœ” å„²å­˜ä¸¦é—œé–‰</button>
        </div>
    </div>
    
    <!-- History -->
    <div id="history-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>æ­·å²ç´€éŒ„</h3>
            <button class="btn-act" style="background:#009688; flex:none; width:auto; padding:0 15px;" onclick="uploadAllPending()">â˜ ä¸Šå‚³å…¨éƒ¨</button>
        </div>
        <div id="log-container"></div>
        <button class="btn-act" style="background:#555; margin-top:20px;" onclick="toggleHistory()">é—œé–‰</button>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAq-sTArXeGDVpdjnbLEzh5WpQ5mkmsyoA",
          authDomain: "badminton-live-6237e.firebaseapp.com",
          databaseURL: "https://badminton-live-6237e-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "badminton-live-6237e",
          storageBucket: "badminton-live-6237e.firebasestorage.app",
          messagingSenderId: "414631038880",
          appId: "1:414631038880:web:acd4ad9ebcda0c4598dec5",
          measurementId: "G-2K7HYBBMXX"
        };

        let db; let isLive = false;
        try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } 
        catch (e) { console.error("Firebase Error:", e); }

        const STORAGE_KEY = 'badminton_v23_state';
        let currentMatchIdx = 0;
        let state = { leftTeam: 'A', scoreA: 0, scoreB: 0, serverTeam: 'A', serverIdxA: 0, serverIdxB: 0, swappedPoints: [] };
        let historyStack = []; let pendingRecords = []; 
        let isVibrationEnabled = true;

        const getEl = (id) => document.getElementById(id);

        window.addEventListener('load', () => {
            loadFromLocal();
            setupLongPress(getEl('name-box-left'), () => editTeamName('left'));
            setupLongPress(getEl('name-box-right'), () => editTeamName('right'));
            setupLongPress(getEl('pos-box-left'), () => editPlayerName('left'));
            setupLongPress(getEl('pos-box-right'), () => editPlayerName('right'));
            bindClickPoint('area-left', 'left');
            bindClickPoint('area-right', 'right');
            render();
        });

        function saveToLocal() {
            const data = {
                state, currentMatchIdx, historyStack, pendingRecords,
                inputs: {
                    umpireName: getEl('umpireName').value,
                    courtNum: getEl('courtNum').value,
                    teamA_name: getEl('teamA_name').value,
                    teamA_players: getEl('teamA_players').value,
                    teamB_name: getEl('teamB_name').value,
                    teamB_players: getEl('teamB_players').value,
                    gform_link: getEl('gform_link').value,
                    swapPoints: getEl('swapPoints').value
                }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromLocal() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const data = JSON.parse(raw);
                state = data.state || state;
                currentMatchIdx = data.currentMatchIdx || 0;
                historyStack = data.historyStack || [];
                pendingRecords = data.pendingRecords || [];
                if(data.inputs) {
                    getEl('umpireName').value = data.inputs.umpireName || "";
                    getEl('courtNum').value = data.inputs.courtNum || "1";
                    getEl('teamA_name').value = data.inputs.teamA_name || "æ©˜éšŠ;æ©˜äºŒéšŠ";
                    getEl('teamA_players').value = data.inputs.teamA_players || "ç‹,æ";
                    getEl('teamB_name').value = data.inputs.teamB_name || "è—éšŠ;è—äºŒéšŠ";
                    getEl('teamB_players').value = data.inputs.teamB_players || "å¼µ,æ—";
                    getEl('gform_link').value = data.inputs.gform_link || "";
                    getEl('swapPoints').value = data.inputs.swapPoints || "11";
                }
                getEl('log-container').innerHTML = '';
                pendingRecords.forEach(r => renderLogItem(r));
            } catch(e) { console.error("Load Error", e); }
        }

        let toastTimer;
        function showToast(msg) {
            const el = getEl('toast-msg'); el.innerHTML = msg; el.classList.add('show');
            clearTimeout(toastTimer); toastTimer = setTimeout(() => el.classList.remove('show'), 2000);
        }

        let onModalConfirm = null;
        function showModal(title, msg, inputMode, callback, defaultValue = "") {
            getEl('u-modal-title').innerText = title; getEl('u-modal-msg').innerText = msg;
            const input = getEl('u-modal-input');
            if (inputMode) { input.style.display = 'block'; input.value = defaultValue; setTimeout(() => input.focus(), 300); } else { input.style.display = 'none'; }
            onModalConfirm = () => { if (inputMode) callback(input.value); else callback(); closeUniversalModal(); };
            getEl('u-modal-confirm-btn').onclick = onModalConfirm;
            getEl('universal-modal').style.display = 'flex';
        }
        function closeUniversalModal() { getEl('universal-modal').style.display = 'none'; onModalConfirm = null; }
        function safeConfirm(msg, yesCallback) { showModal("ç¢ºèª", msg, false, yesCallback); }
        function safePrompt(title, defaultValue, callback) { showModal("ç·¨è¼¯", title, true, callback, defaultValue); }

        function toggleFullScreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => showToast("ç„¡æ³•å…¨è¢å¹•")); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }

        function toggleVibration(checked) { isVibrationEnabled = checked; if(checked) doVibrate(50); }
        function doVibrate(ms) { if(isVibrationEnabled && navigator.vibrate) navigator.vibrate(ms); }

        function bindClickPoint(elemId, side) {
            const el = getEl(elemId);
            el.addEventListener('click', (e) => {
                if (e.target.closest('.btn-act') || e.target.closest('#controls-overlay')) return;
                if (el.dataset.longPressHandled === "true") { el.dataset.longPressHandled = "false"; return; }
                doVibrate(30); addPoint(side);
                el.classList.remove('flash-active'); void el.offsetWidth; el.classList.add('flash-active');
            });
        }

        function setupLongPress(element, callback) {
            let timer; const duration = 600;
            const start = () => { timer = setTimeout(() => { doVibrate(50); const parentArea = element.closest('.side'); if(parentArea) parentArea.dataset.longPressHandled = "true"; callback(); }, duration); };
            const cancel = () => { clearTimeout(timer); };
            element.addEventListener('mousedown', start); element.addEventListener('touchstart', start, {passive: true});
            element.addEventListener('mouseup', cancel); element.addEventListener('touchend', cancel);
            element.addEventListener('touchcancel', cancel); element.addEventListener('mouseleave', cancel);
        }

        function editUmpireName() { safePrompt("ä¿®æ”¹ä¸»å¯©å§“å", getEl('umpireName').value, (val) => { if(val !== null) { getEl('umpireName').value = val; saveToLocal(); syncToFirebase(); } }); }
        function editCourtNum() { safePrompt("ä¿®æ”¹å ´åœ°ç·¨è™Ÿ", getEl('courtNum').value, (val) => { if(val) { getEl('courtNum').value = val; saveToLocal(); syncToFirebase(); } }); }
        function editTeamName(side) {
            let key = (side === 'left') ? state.leftTeam : (state.leftTeam === 'A' ? 'B' : 'A');
            safePrompt(`ä¿®æ”¹ ${key} éšŠåç¨±`, getTeamName(key), (val) => { if(val) { updateInputSegment(`team${key}_name`, val); render(); } });
        }
        function editPlayerName(side) {
            let key = (side === 'left') ? state.leftTeam : (state.leftTeam === 'A' ? 'B' : 'A');
            let idx = (key === 'A') ? state.serverIdxA : state.serverIdxB;
            safePrompt("ä¿®æ”¹çƒå“¡", getPlayerName(key, idx), (val) => { if(val) { updatePlayerInput(`team${key}_players`, idx, val); render(); } });
        }

        function addPoint(side) {
            saveState();
            let team = (side === 'left') ? state.leftTeam : (state.leftTeam === 'A' ? 'B' : 'A');
            if (team === 'A') state.scoreA++; else state.scoreB++;
            if (team !== state.serverTeam) {
                state.serverTeam = team;
                if (team === 'A') state.serverIdxA = getNextIdx('A', state.serverIdxA); else state.serverIdxB = getNextIdx('B', state.serverIdxB);
            }
            checkSwap(); render();
        }

        function updateInputSegment(id, newVal) {
            let input = getEl(id); let parts = input.value.split(/[;ï¼›]/);
            let safeIdx = Math.min(currentMatchIdx, parts.length - 1);
            parts[safeIdx] = newVal; input.value = parts.join(' ; '); saveToLocal();
        }
        function updatePlayerInput(id, pIdx, newVal) {
            let input = getEl(id); let mParts = input.value.split(/[;ï¼›]/);
            let mIdx = Math.min(currentMatchIdx, mParts.length - 1);
            let players = mParts[mIdx].split(/[,ï¼Œ]/);
            players[pIdx % players.length] = newVal;
            mParts[mIdx] = players.join(','); input.value = mParts.join(' ; '); saveToLocal();
        }

        function getCurrentPlayersString(teamKey) {
            let raw = getEl(`team${teamKey}_players`).value;
            let parts = raw.split(/[;ï¼›]/);
            let idx = Math.min(currentMatchIdx, parts.length - 1);
            return parts[idx] ? parts[idx].trim() : "";
        }

        function getSegmentedData(id, idx) { let val = getEl(id).value.split(/[;ï¼›]/); return val[Math.min(idx, val.length-1)]?.trim() || ""; }
        function getTeamName(k) { return getSegmentedData(`team${k}_name`, currentMatchIdx) || `éšŠ${k}`; }
        function getPlayerName(k, i) { let arr = getSegmentedData(`team${k}_players`, currentMatchIdx).split(/[,ï¼Œ]/); return arr.length ? arr[i % arr.length].trim() : ""; }
        function getNextIdx(k, i) { let arr = getSegmentedData(`team${k}_players`, currentMatchIdx).split(/[,ï¼Œ]/); let len = arr.length || 1; return (i + 1) % len; }

        function undoPoint() { if (historyStack.length) { state = historyStack.pop(); render(); } }
        function saveState() { let copy = JSON.parse(JSON.stringify(state)); historyStack.push(copy); if(historyStack.length>50) historyStack.shift(); }
        
        function checkSwap() {
            let max = Math.max(state.scoreA, state.scoreB);
            let pts = getEl('swapPoints').value.split(',').map(Number);
            if (pts.includes(max) && !state.swappedPoints.includes(max)) {
                state.swappedPoints.push(max); 
                safeConfirm(`åˆ†æ•¸ ${state.scoreA}:${state.scoreB} æ›é‚Šï¼Ÿ`, () => { state.leftTeam = (state.leftTeam==='A')?'B':'A'; render(); });
            }
        }
        
        function swapSidesManual() { safeConfirm("ç¢ºèªæ‰‹å‹•äº¤æ›å ´åœ°ï¼Ÿ", () => { state.leftTeam = (state.leftTeam==='A')?'B':'A'; render(); }); }
        function resetGame() { state = { leftTeam: 'A', scoreA: 0, scoreB: 0, serverTeam: getEl('initServer').value, serverIdxA: 0, serverIdxB: 0, swappedPoints: [] }; historyStack = []; render(); saveToLocal(); }
        
        function logGameOnly() {
            if (pendingRecords.length > 0) {
                const last = pendingRecords[pendingRecords.length - 1];
                if (last.matchStr === `G${currentMatchIdx+1}` && last.sA === state.scoreA && last.sB === state.scoreB) {
                    showToast("âš ï¸ æ­¤æ¯”åˆ†å·²ç´€éŒ„é"); return;
                }
            }
            logGame(); 
            const link = getEl('gform_link').value;
            if (!link) showToast("âš ï¸ å·²å­˜æœ¬æ©Ÿ (æœªè¨­å®šé€£çµ)"); else showToast("âœ… å·²ç´€éŒ„æ¯”åˆ†");
        }

        function endMatchAndNext() {
            safeConfirm(`ğŸ çµæŸç¬¬ ${currentMatchIdx+1} å ´ï¼Œä¸¦é€²å…¥ä¸‹ä¸€å ´ï¼Ÿ`, () => { 
                logGame(); 
                currentMatchIdx++; 
                resetGame(); 
                showToast("âœ… é€²å…¥ä¸‹ä¸€å ´"); 
            });
        }

        // V33: æ¸…é™¤å ´åœ°è³‡æ–™ (ä¸‹ç·š)
        function clearCourtData() {
            if(!isLive) { showToast("âš ï¸ è«‹å…ˆé–‹å•Ÿç›´æ’­é€£ç·š"); return; }
            const cNum = getEl('courtNum').value;
            safeConfirm(`ç¢ºå®šè¦æ¸…é™¤ã€å ´åœ° ${cNum}ã€‘çš„ç›´æ’­è³‡æ–™å—ï¼Ÿ\n(è§€çœ¾å°‡ç„¡æ³•çœ‹åˆ°æ­¤å ´åœ°)`, () => {
                db.ref('courts/court_' + cNum).remove()
                    .then(() => showToast("ğŸ—‘ï¸ å ´åœ°å·²ä¸‹ç·š"))
                    .catch(e => showToast("âŒ æ¸…é™¤å¤±æ•—"));
            });
        }

        function render() {
            let isA_Left = (state.leftTeam === 'A');
            getEl('name-box-left').innerText = getTeamName(isA_Left?'A':'B');
            getEl('name-box-right').innerText = getTeamName(isA_Left?'B':'A');
            getEl('disp-score-left').innerText = isA_Left ? state.scoreA : state.scoreB;
            getEl('disp-score-right').innerText = isA_Left ? state.scoreB : state.scoreA;
            getEl('match-counter').innerText = `G${currentMatchIdx+1}`;
            
            getEl('area-left').className = isA_Left ? "side team-a" : "side team-b"; 
            getEl('area-right').className = isA_Left ? "side team-b" : "side team-a";
            
            getEl('area-left').classList.remove('serving'); getEl('area-right').classList.remove('serving');
            if (state.serverTeam === state.leftTeam) getEl('area-left').classList.add('serving'); else getEl('area-right').classList.add('serving');

            ['pos-l-left','pos-r-left','pos-l-right','pos-r-right'].forEach(id=>{ const el = getEl(id); el.classList.remove('pos-active'); el.innerText = ""; });

            let serverA = getPlayerName('A', state.serverIdxA);
            let partnerA = getPlayerName('A', getNextIdx('A', state.serverIdxA));
            let serverB = getPlayerName('B', state.serverIdxB);
            let partnerB = getPlayerName('B', getNextIdx('B', state.serverIdxB));

            let leftTeamKey = state.leftTeam; 
            let leftTeamScore = (leftTeamKey === 'A') ? state.scoreA : state.scoreB;
            let leftServerName = (leftTeamKey === 'A') ? serverA : serverB;
            let leftPartnerName = (leftTeamKey === 'A') ? partnerA : partnerB;
            let leftTeamTotalPlayers = getSegmentedData(`team${leftTeamKey}_players`, currentMatchIdx).split(/[,ï¼Œ]/).length;

            if (leftTeamScore % 2 === 0) { 
                getEl('pos-r-left').innerText = leftServerName; 
                if(leftTeamTotalPlayers > 1) getEl('pos-l-left').innerText = leftPartnerName; 
            } else { 
                getEl('pos-l-left').innerText = leftServerName; 
                if(leftTeamTotalPlayers > 1) getEl('pos-r-left').innerText = leftPartnerName; 
            }

            let rightTeamKey = (leftTeamKey === 'A') ? 'B' : 'A';
            let rightTeamScore = (rightTeamKey === 'A') ? state.scoreA : state.scoreB;
            let rightServerName = (rightTeamKey === 'A') ? serverA : serverB;
            let rightPartnerName = (rightTeamKey === 'A') ? partnerA : partnerB;
            let rightTeamTotalPlayers = getSegmentedData(`team${rightTeamKey}_players`, currentMatchIdx).split(/[,ï¼Œ]/).length;

            if (rightTeamScore % 2 === 0) { 
                getEl('pos-r-right').innerText = rightServerName; 
                if(rightTeamTotalPlayers > 1) getEl('pos-l-right').innerText = rightPartnerName;
            } else { 
                getEl('pos-l-right').innerText = rightServerName; 
                if(rightTeamTotalPlayers > 1) getEl('pos-r-right').innerText = rightPartnerName;
            }

            let activeTeamSide = (state.serverTeam === state.leftTeam) ? 'left' : 'right';
            let activeScore = (state.serverTeam === 'A') ? state.scoreA : state.scoreB;
            let targetId = (activeTeamSide === 'left') ? ((activeScore % 2 === 0) ? 'pos-r-left' : 'pos-l-left') : ((activeScore % 2 === 0) ? 'pos-r-right' : 'pos-l-right');
            getEl(targetId).classList.add('pos-active');

            syncToFirebase();
            saveToLocal(); 
        }

        function changeScoreSize(val) { document.documentElement.style.setProperty('--score-size', val + 'px'); getEl('size-val').innerText = val; }
        
        function handleLiveClick() {
            if (isLive) { isLive = false; updateLiveUI(); } 
            else {
                safePrompt("è«‹è¼¸å…¥å ´åœ°ç·¨è™Ÿ", getEl('courtNum').value, (val) => {
                    if(!val) { showToast('è«‹è¼¸å…¥å ´åœ°'); return; }
                    getEl('courtNum').value = val;
                    setTimeout(() => {
                        safePrompt("è«‹è¼¸å…¥ä¸»å¯©å§“å", getEl('umpireName').value, (uVal) => {
                            getEl('umpireName').value = uVal || "åŸéšçˆº";
                            isLive = true; updateLiveUI(); syncToFirebase();
                        });
                    }, 200);
                });
            }
        }
        
        function updateLiveUI() {
            const el = getEl('liveToggle'); const txt = getEl('liveText');
            if (isLive) { el.classList.add('active'); txt.innerText = "ç›´æ’­ä¸­"; } 
            else { el.classList.remove('active'); txt.innerText = "é›¢ç·š"; }
        }
        function syncToFirebase() {
            if (!isLive || !db) return;
            const courtNum = getEl('courtNum').value; if(!courtNum) return;
            db.ref('courts/court_' + courtNum).set({
                court: courtNum, match: `G${currentMatchIdx+1}`, umpire: getEl('umpireName').value,
                teamA: getTeamName('A'), teamB: getTeamName('B'), 
                playersA: getCurrentPlayersString('A'), playersB: getCurrentPlayersString('B'),
                scoreA: state.scoreA, scoreB: state.scoreB,
                server: getPlayerName(state.serverTeam, state.serverTeam==='A'?state.serverIdxA:state.serverIdxB),
                serverTeam: state.serverTeam, timestamp: Date.now()
            });
        }

        function logGame() {
            const record = {
                id: Date.now(), court: getEl('courtNum').value || "ç·´ç¿’", umpire: getEl('umpireName').value || "-",
                tA: getTeamName('A'), tB: getTeamName('B'), sA: state.scoreA, sB: state.scoreB, winner: state.scoreA > state.scoreB ? getTeamName('A') : getTeamName('B'),
                matchStr: `G${currentMatchIdx+1}`, status: 'pending'
            };
            pendingRecords.push(record); renderLogItem(record);
            saveToLocal();
        }
        function renderLogItem(r) {
            let div = document.createElement('div'); div.className = 'log-item'; div.id = `log-${r.id}`;
            div.innerHTML = `<div class="log-info"><b>${r.matchStr} (å ´${r.court})</b><br>${r.tA} ${r.sA}:${r.sB} ${r.tB}<br>å‹: ${r.winner}</div><div class="log-status status-pending" id="status-${r.id}">å¾…å‚³é€</div>`;
            getEl('log-container').prepend(div);
        }
        function parseLinkAndGetIDs(link) {
            if (!link.includes('docs.google.com')) return null;
            const baseUrl = link.split('?')[0].replace('viewform', 'formResponse');
            const params = new URLSearchParams(link.split('?')[1]);
            const mapping = {};
            const keys = { '__COURT__': 'court', '__UMPIRE__': 'umpire', '__TEAMA__': 'tA', '__TEAMB__': 'tB', '__SCOREA__': 'sA', '__SCOREB__': 'sB', '__WINNER__': 'winner' };
            params.forEach((value, key) => { if (keys[value]) mapping[keys[value]] = key; });
            return { baseUrl, mapping };
        }
        async function uploadAllPending() {
            const link = getEl('gform_link').value;
            if (!link) { showToast("è«‹å…ˆè²¼ä¸Š Google Form é€£çµï¼"); return; }
            const config = parseLinkAndGetIDs(link);
            if (!config || Object.keys(config.mapping).length < 7) { showToast("é€£çµæ ¼å¼éŒ¯èª¤ï¼"); return; }
            const targets = pendingRecords.filter(r => r.status === 'pending');
            if (targets.length === 0) { showToast("æ²’æœ‰å¾…å‚³é€çš„ç´€éŒ„"); return; }
            
            safeConfirm(`ä¸Šå‚³ ${targets.length} ç­†è³‡æ–™ï¼Ÿ`, async () => {
                for (let r of targets) {
                    updateStatus(r.id, 'sending', 'å‚³é€ä¸­...');
                    const formData = new FormData();
                    formData.append(config.mapping.court, r.court); formData.append(config.mapping.umpire, r.umpire);
                    formData.append(config.mapping.tA, r.tA); formData.append(config.mapping.tB, r.tB);
                    formData.append(config.mapping.sA, r.sA); formData.append(config.mapping.sB, r.sB);
                    formData.append(config.mapping.winner, r.winner);
                    try {
                        await fetch(config.baseUrl, { method: 'POST', mode: 'no-cors', body: formData });
                        r.status = 'done'; updateStatus(r.id, 'done', 'âœ… å·²ä¸Šå‚³');
                    } catch (e) {
                        r.status = 'error'; updateStatus(r.id, 'error', 'âŒ å¤±æ•—');
                    }
                    saveToLocal(); // Update status in storage
                    await new Promise(res => setTimeout(res, 500));
                }
                showToast("ä¸Šå‚³ä½œæ¥­çµæŸ");
            });
        }
        function updateStatus(id, type, text) { const el = getEl(`status-${id}`); if (el) { el.className = `log-status status-${type}`; el.innerText = text; } }
        function openSettings() {
            settingsSnapshot = {
                gform_link: getEl('gform_link').value,
                teamA_name: getEl('teamA_name').value, teamA_players: getEl('teamA_players').value,
                teamB_name: getEl('teamB_name').value, teamB_players: getEl('teamB_players').value,
                swapPoints: getEl('swapPoints').value
            };
            getEl('settings-panel').classList.add('panel-visible');
        }
        function cancelSettings() {
            if (settingsSnapshot) {
                getEl('gform_link').value = settingsSnapshot.gform_link || "";
                getEl('teamA_name').value = settingsSnapshot.teamA_name || ""; getEl('teamA_players').value = settingsSnapshot.teamA_players || "";
                getEl('teamB_name').value = settingsSnapshot.teamB_name || ""; getEl('teamB_players').value = settingsSnapshot.teamB_players || "";
                getEl('swapPoints').value = settingsSnapshot.swapPoints || "";
            }
            getEl('settings-panel').classList.remove('panel-visible'); render(); 
        }
        function saveSettings() { render(); saveToLocal(); syncToFirebase(); getEl('settings-panel').classList.remove('panel-visible'); showToast("âœ… è¨­å®šå·²å„²å­˜"); }
        function toggleHistory() { getEl('history-panel').classList.toggle('panel-visible'); }
    </script>
</body>
</html>