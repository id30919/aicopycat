<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¸ å¤§èˆ¹ç¾½çƒå­£æ‰“è¦åŠƒèˆ‡äººæ•¸è²¡å‹™åˆ†æ ğŸ’°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; margin: 0; padding: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1400px; margin: auto; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15); }
        h1 { color: #007bff; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        
        /* æ¨™é¡Œå€å¡Š */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 15px; border-left: 6px solid #ffc107; padding-left: 12px; }
        .section-header h2 { margin: 0; border: none; padding: 0; font-size: 1.3em; color: #333; }
        h2 { border-left: 6px solid #ffc107; padding-left: 12px; color: #333; margin-top: 20px; margin-bottom: 15px; font-size: 1.3em; }
        
        /* RWD è¡¨æ ¼æ²å‹• */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 15px; border: 1px solid #eee; }

        /* è¡¨æ ¼åŸºæœ¬è¨­å®š */
        #input-table, #result-table { width: 100%; border-collapse: collapse; font-size: 0.95em; table-layout: fixed; min-width: 900px; }
        #input-table th, #input-table td, #result-table th, #result-table td { border: 1px solid #ccc; padding: 8px 4px; text-align: center !important; vertical-align: middle !important; word-wrap: break-word; }
        #input-table th, #result-table th { background-color: #e9ecef; color: #495057; font-weight: bold; }
        #input-table input { text-align: center !important; width: 90%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .nowrap-header { white-space: nowrap !important; }
        .text-center { text-align: center !important; }
        
        /* =========================================
           æ ¸å¿ƒä¿®æ”¹ï¼šåº•éƒ¨è³‡è¨Šå€å¡Šæ¨£å¼ (é‚„åŸæˆªåœ–)
           ========================================= */
        
        /* 1. å·¦å´ï¼šä¸é–‹åœ˜æ—¥æœŸå€å¡Š */
        .left-info-box {
            text-align: left !important;      /* å¼·åˆ¶é å·¦ */
            vertical-align: top !important;   /* å…§å®¹ç½®é ‚ */
            padding: 20px 30px !important;    /* å¢åŠ å…§è·è®“ç‰ˆé¢èˆ’é© */
            background-color: #FCE4EC !important; /* ç²‰ç´…åº• */
            border: 1px solid #ccc;
        }

        /* 2. å³å´ï¼šçµ„åˆå„ªæƒ å€å¡Š (Header/Body/Footer) */
        .right-info-box-header {
            background-color: #FFF3E0 !important; /* æ©˜è‰²åº• */
            text-align: left !important;      /* å¼·åˆ¶é å·¦ */
            vertical-align: top !important;
            padding: 20px 30px 5px 30px !important; 
            border-top: 1px solid #ccc !important;
            border-left: 1px solid #ccc !important;
            border-right: 1px solid #ccc !important;
            border-bottom: none !important; 
        }
        .right-info-box-body {
            background-color: #FFF3E0 !important;
            padding: 0 30px !important;
            border-left: 1px solid #ccc !important;
            border-right: 1px solid #ccc !important;
            border-top: none !important;
            border-bottom: none !important;
        }
        .right-info-box-footer {
            background-color: #FFF3E0 !important;
            padding: 0 30px 20px 30px !important;
            border-left: 1px solid #ccc !important;
            border-right: 1px solid #ccc !important;
            border-top: none !important;
            border-bottom: 1px solid #ccc !important;
        }

        /* 3. æ¨™é¡Œæ¨£å¼ (å«åº•ç·š) */
        .box-title {
            display: block;
            text-align: left !important; /* æ¨™é¡Œæ–‡å­—é å·¦ */
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            width: 100%;
        }
        /* ç²‰ç´…æ¨™é¡Œç·š */
        .title-pink { 
            color: #C2185B; 
            border-bottom: 2px solid #F48FB1; /* æˆªåœ–ä¸­çš„ç²‰ç´…æ©«ç·š */
        }
        /* æ©˜è‰²æ¨™é¡Œç·š */
        .title-orange { 
            color: #E65100; 
            border-bottom: 2px solid #FF9800; /* æˆªåœ–ä¸­çš„æ©˜è‰²æ©«ç·š */
        }

        /* 4. å…§å®¹æ–‡å­—æ’ç‰ˆ */
        .combo-row {
            display: flex;
            justify-content: space-between; /* é …ç›®é å·¦ï¼Œé‡‘é¡é å³ */
            margin-bottom: 10px;
            font-weight: normal;
            font-size: 1em;
            color: #333;
        }
        
        .off-date-content {
            text-align: left !important; /* å¼·åˆ¶é å·¦ */
            line-height: 1.8;
            font-size: 1em;
            color: #333;
        }
        /* ä¿®æ­£ ul li çš„é è¨­ç¸®æ’ */
        .off-date-content ul {
            margin: 0;
            padding-left: 0; /* ç§»é™¤åœ“é»ç¸®æ’ */
            list-style: none;
        }
        /* ========================================= */

        /* è¼¸å…¥èˆ‡è¨ˆç®—æ¨£å¼ */
        .input-row { display: flex; align-items: center; margin-bottom: 15px; font-size: 1.1em; font-weight: bold; white-space: nowrap; flex-wrap: wrap; }
        .period-input { width: 250px; text-align: center; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-left: 10px; font-size: 1em; color: #333; }
        
        .fullhit-container { margin-top: 20px; display: flex; align-items: center; flex-wrap: nowrap; gap: 15px; white-space: nowrap; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fullhit-label { font-weight: bold; flex-shrink: 0; }
        .fullhit-input { width: 100px !important; text-align: center !important; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; color: #333; }
        
        .calc-info { font-size: 0.9em; color: #555; background: #f8f9fa; padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); white-space: nowrap; }
        .calc-val { color: #d63384; font-weight: bold; margin-left: 5px; font-size: 1.1em; }
        .calc-info.highlight { background-color: #e8f5e9; border-color: #81c784; color: #1b5e20; }
        .calc-val.highlight { color: #2e7d32; }

        .dynamic-inputs, .analysis-section, .calendar-section { padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; background-color: #fff; }
        
        /* æŒ‰éˆ•æ¨£å¼ (å¼·åˆ¶ä¸æ›è¡Œ) */
        .button { 
            background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-top: 10px; transition: 0.2s; 
            width: auto; 
            min-width: 250px;
            white-space: nowrap; /* é—œéµ */
            display: inline-block;
        }
        .button:hover { background-color: #218838; }
        .save-btn { background-color: #17a2b8; font-size: 0.9em; padding: 6px 12px; margin: 0; width: auto; min-width: 0; }
        .save-btn:hover { background-color: #138496; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; line-height: 1.4; box-sizing: border-box; }
        
        /* è¡Œäº‹æ›† */
        .calendar-title-main { text-align: center; margin-bottom: 20px; color: #333; border-left: none !important; padding-left: 0 !important; }
        .calendar-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .month-card { border: 1px solid #ddd; padding: 5px; border-radius: 8px; width: 100%; max-width: 320px; background: #fff; }
        .month-title { text-align: center; font-weight: bold; margin-bottom: 5px; font-size: 1.1em; background: #007bff; color: white; padding: 5px; border-radius: 4px; }
        .cal-table { width: 100%; text-align: center; font-size: 0.9em; table-layout: fixed; }
        .cal-table th { background: white; color: #333; border-bottom: 1px solid #eee; padding: 2px; }
        .cal-table td { padding: 6px 2px; border: none; cursor: default; }
        .day-play { background-color: #C8E6C9; color: #1B5E20; font-weight: bold; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; } 
        .day-off { background-color: #FFCDD2; color: #B71C1C; font-weight: bold; border-radius: 50%; text-decoration: line-through; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; }
        .day-holiday { background-color: #E1BEE7; color: #4A148C; font-weight: bold; border-radius: 50%; border: 2px solid #9C27B0; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; }
        .legend-box { margin-top: 10px; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; font-size: 0.85em; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; display: inline-block; }

        /* åœ–è¡¨èˆ‡çµ±è¨ˆ */
        .summary-stats { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { flex: 1 1 45%; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .stat-title { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 1.2em; font-weight: bold; }
        .pos { color: #28a745; }
        .neg { color: #dc3545; }
        .neu { color: #007bff; }
        .cnt { color: #6f42c1; }
        .ai-verdict-box { background-color: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 0.95em; }
        .ai-title { font-weight: bold; color: #0d47a1; margin-bottom: 5px; display: block; }

        .analysis-dashboard { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .chart-card { flex: 1 1 100%; background: #f8f9fa; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-wrapper { height: 300px; position: relative; }

        @media (max-width: 768px) {
            .input-row { flex-direction: column; align-items: flex-start; }
            .input-row label { margin-bottom: 5px; }
            .period-input { margin-left: 0; width: 100%; box-sizing: border-box; }
            .fullhit-container { justify-content: flex-start; padding-bottom: 15px; }
            .summary-stats { gap: 8px; }
            .stat-box { min-width: 45%; padding: 8px; }
            .chart-wrapper { height: 250px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¸ å¤§èˆ¹ç¾½çƒå­£æ‰“è¦åŠƒèˆ‡äººæ•¸è²¡å‹™åˆ†æ ğŸ’°</h1>

    <!-- 1. å­£æ‰“è¨ˆç•«è¼¸å…¥ -->
    <div class="dynamic-inputs">
        <div class="section-header">
            <h2>ğŸ—“ï¸ å­£åº¦å­£æ‰“è¨ˆç•«</h2>
            <button class="button save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
        
        <div class="input-row">
            <label>å­£åº¦åç¨±/æœŸé–“ï¼š</label>
            <input type="text" id="period-input" value="2026 ç¬¬ä¸€å­£ (1-3æœˆ)" class="period-input">
        </div>
        
        <div class="table-responsive">
            <table id="input-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">é€±æ¬¡</th>
                        <th style="width: 110px;">æ‰“çƒæ™‚é–“</th>
                        <th style="width: 80px;">å ´åœ°</th>
                        <th style="width: 60px;">å ´æ¬¡</th>
                        <th style="width: 120px;">ä¸é–‹åœ˜æ—¥æœŸ</th>
                        <th style="width: 80px;">é›¶æ‰“è²»</th>
                        <th style="width: 80px;">å­£æ‰“è²»</th>
                        <th style="width: 120px;">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="input-body">
                    <tr data-key="mon"><td>é€±ä¸€</td><td>20:30-22:30</td><td><input type="text" id="mon_venue" value="åœ‹èªå¯¦å°"></td><td><input type="number" id="mon_total" value="12"></td><td><input type="text" id="mon_off" value="1/1ã€2/16"></td><td><input type="number" id="mon_drop" value="250"></td><td><input type="number" id="mon_sea" value="210"></td><td><input type="text" id="mon_note" value="è«‹å‡ä¸é€€è²»"></td></tr>
                    <tr data-key="tue2"><td>é€±äºŒ (2h)</td><td>20:30-22:30</td><td><input type="text" id="tue2_venue" value="æ¿æ©‹ç¾½çƒ"></td><td><input type="number" id="tue2_total" value="13"></td><td><input type="text" id="tue2_off" value="2/17"></td><td><input type="number" id="tue2_drop" value="250"></td><td><input type="number" id="tue2_sea" value="210"></td><td><input type="text" id="tue2_note" value="è«‹å‡å¯è£œä½"></td></tr>
                    <tr data-key="tue3"><td>é€±äºŒ (3h)</td><td>20:30-23:30</td><td><input type="text" id="tue3_venue" value="æ¿æ©‹ç¾½çƒ"></td><td><input type="number" id="tue3_total" value="13"></td><td><input type="text" id="tue3_off" value="2/17"></td><td><input type="number" id="tue3_drop" value="370"></td><td><input type="number" id="tue3_sea" value="310"></td><td><input type="text" id="tue3_note" value="è«‹å‡å¯è£œä½"></td></tr>
                    <tr data-key="thu"><td>é€±å››</td><td>20:30-23:30</td><td><input type="text" id="thu_venue" value="æ¿æ©‹ç¾½çƒ"></td><td><input type="number" id="thu_total" value="12"></td><td><input type="text" id="thu_off" value="2/19"></td><td><input type="number" id="thu_drop" value="370"></td><td><input type="number" id="thu_sea" value="310"></td><td><input type="text" id="thu_note" value="è«‹å‡ä¸é€€è²»"></td></tr>
                    <tr data-key="sat"><td>é€±å…­</td><td>14:00-18:00</td><td><input type="text" id="sat_venue" value="æ¿æ©‹ç¾½çƒ"></td><td><input type="number" id="sat_total" value="10"></td><td><input type="text" id="sat_off" value="2/28"></td><td><input type="number" id="sat_drop" value="450"></td><td><input type="number" id="sat_sea" value="0" disabled style="background:#eee;"></td><td><input type="text" id="sat_note" value="ä¸é–‹æ”¾å­£æ‰“"></td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="fullhit-container">
            <div style="display:flex; align-items:center;">
                <span class="fullhit-label">å…¨å£˜æ‰“å„ªæƒ é‡‘é¡ï¼š</span>
                <input type="number" id="fullhit-discount" value="870" class="fullhit-input">
            </div>
            
            <div style="display:flex; gap: 5px; align-items: center;">
                <span class="calc-info">
                    (é€±ä¸€+äºŒ2h+å››) åŸåƒ¹ï¼š<span id="calc-val-2h" class="calc-val">0</span>
                </span>
                <span class="calc-info highlight">
                    æŠ˜æ‰£å¾Œï¼š<span id="calc-final-2h" class="calc-val highlight">0</span>
                </span>
            </div>

            <div style="display:flex; gap: 5px; align-items: center;">
                <span class="calc-info">
                    (é€±ä¸€+äºŒ3h+å››) åŸåƒ¹ï¼š<span id="calc-val-3h" class="calc-val">0</span>
                </span>
                <span class="calc-info highlight">
                    æŠ˜æ‰£å¾Œï¼š<span id="calc-final-3h" class="calc-val highlight">0</span>
                </span>
            </div>
        </div>
        
        <button class="button" onclick="generateTable()">ğŸ“ ç”Ÿæˆè¡¨æ ¼</button>
    </div>

    <!-- 2. è¡¨æ ¼è¼¸å‡ºå€ -->
    <div id="output-area" style="display:none;">
        <h2 id="table-title">ğŸ“Š å­£æ‰“è²»ç”¨åŠå„ªæƒ æ–¹æ¡ˆ</h2>
        
        <div class="table-responsive">
            <table id="result-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th style="width: 80px;">é€±æ¬¡/æ™‚æ®µ</th>
                        <th style="width: 90px;">æ‰“çƒæ™‚é–“</th>
                        <th style="width: 50px;">æ™‚æ•¸</th>
                        <th style="width: 70px;" class="nowrap-header">å­£æ‰“å ´æ•¸</th>
                        <th style="width: 120px;">ä¸é–‹åœ˜æ—¥æœŸ</th>
                        <th style="width: 70px;" class="nowrap-header">æ¯å ´é›¶æ‰“</th>
                        <th style="width: 80px;" class="nowrap-header">é›¶æ‰“åŸåƒ¹</th>
                        <th style="width: 80px;" class="nowrap-header">æ¯å ´å­£æ‰“</th>
                        <th style="width: 80px;" class="nowrap-header">å­£æ‰“å„ªæƒ </th>
                        <th style="width: 50px;">æŠ˜æ•¸</th>
                        <th style="width: 100px;">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="result-body"></tbody>
                <tfoot id="result-foot"></tfoot>
            </table>
        </div>
    </div>

    <!-- è¡Œäº‹æ›†å€å¡Š -->
    <div id="calendar-area" class="calendar-section" style="display:none;">
        <h2 class="calendar-title-main">ğŸ“… 2026 ç¬¬ä¸€å­£æ‰“çƒè¡Œäº‹æ›†</h2>
        <div class="legend-box">
            <div class="legend-item"><span class="dot" style="background:#C8E6C9;"></span>æ‰“çƒæ—¥</div>
            <div class="legend-item"><span class="dot" style="background:#FFCDD2;"></span>åœæ‰“/è«‹å‡</div>
            <div class="legend-item"><span class="dot" style="background:#E1BEE7; border:1px solid #9C27B0;"></span>åœ‹å®šå‡æ—¥</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <!-- 3. æ”¶æ”¯åˆ†æè¼¸å…¥ -->
    <div class="analysis-section">
        <h2>ğŸ“‘ å­£åº¦æ”¶æ”¯èˆ‡é›¶æ‰“äººæ•¸åˆ†æ</h2>
        <p>è«‹è²¼ä¸Šæ”¶æ”¯æ˜ç´° (æ ¼å¼ï¼šæ—¥æœŸ é‡‘é¡ å‚™è¨»)ï¼š</p>
        <textarea id="expense-data" placeholder="ç¯„ä¾‹ï¼š&#10;8æœˆ31æ—¥	-36000	åœ‹èªå¯¦å°å ´åœ°è²»ç”¨&#10;10æœˆ7æ—¥	11100	é€±äºŒ3å°æ™‚é›¶æ‰“ï¼ˆ30äººï¼‰"></textarea>
        <button class="button" onclick="analyzeData()">ğŸš€ åŸ·è¡Œæ”¶æ”¯åˆ†æèˆ‡é ä¼°</button>
    </div>

    <!-- 4. åˆ†æåœ–è¡¨å€ -->
    <div id="analysis-dashboard" style="display:none;">
        <div class="summary-stats">
            <div class="stat-box"><div class="stat-title">ç¸½æ”¶å…¥</div><div id="val-inc" class="stat-value neu">0</div></div>
            <div class="stat-box"><div class="stat-title">ç¸½æ”¯å‡º</div><div id="val-exp" class="stat-value neg">0</div></div>
            <div class="stat-box"><div class="stat-title">ç¸½çµé¤˜</div><div id="val-net" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-title">ç¸½é›¶æ‰“äººæ•¸</div><div id="val-hc" class="stat-value cnt">0</div></div>
        </div>

        <div class="ai-verdict-box">
            <span class="ai-title">ğŸ¤– AI ç‡Ÿé‹å»ºè­°èˆ‡ç¸½çµï¼š</span>
            <span id="ai-verdict-text">ç­‰å¾…åˆ†ææ•¸æ“š...</span>
        </div>

        <div class="analysis-dashboard">
            <div class="chart-card">
                <h4>ğŸ’¸ æ ¸å¿ƒæ”¯å‡ºä½”æ¯”</h4>
                <div class="chart-wrapper"><canvas id="chart-expense"></canvas></div>
            </div>
            <div class="chart-card">
                <h4>ğŸ’° æ”¶å…¥ä¾†æºä½”æ¯”</h4>
                <div class="chart-wrapper"><canvas id="chart-income"></canvas></div>
            </div>
            <div class="chart-card" style="min-width: 100%;">
                <h4>ğŸ‘¥ å„é€±æ¬¡é›¶æ‰“äººæ•¸çµ±è¨ˆ (æ™‚æ®µå †ç–Š)</h4>
                <div class="chart-wrapper"><canvas id="chart-headcount"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    function setupInputListeners() {
        const syncPairs = [['tue2_total', 'tue3_total'], ['tue2_off', 'tue3_off']];
        syncPairs.forEach(pair => {
            const el1 = document.getElementById(pair[0]);
            const el2 = document.getElementById(pair[1]);
            if(el1 && el2) {
                el1.addEventListener('input', function() { el2.value = this.value; calculateFullHitCost(); });
                el2.addEventListener('input', function() { el1.value = this.value; calculateFullHitCost(); });
            }
        });

        const calcInputs = ['mon_total', 'mon_sea', 'tue2_total', 'tue2_sea', 'tue3_total', 'tue3_sea', 'thu_total', 'thu_sea'];
        calcInputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.addEventListener('input', calculateFullHitCost); }
        });

        const discountInput = document.getElementById('fullhit-discount');
        if (discountInput) { discountInput.addEventListener('input', calculateFullHitCost); }
    }

    function calculateFullHitCost() {
        const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
        const monCost = getVal('mon_total') * getVal('mon_sea');
        const thuCost = getVal('thu_total') * getVal('thu_sea');
        const tue2Cost = getVal('tue2_total') * getVal('tue2_sea');
        const tue3Cost = getVal('tue3_total') * getVal('tue3_sea');
        const discount = getVal('fullhit-discount');

        const total2h = monCost + tue2Cost + thuCost;
        const total3h = monCost + tue3Cost + thuCost;
        const final2h = total2h - discount;
        const final3h = total3h - discount;

        document.getElementById('calc-val-2h').textContent = total2h.toLocaleString();
        document.getElementById('calc-val-3h').textContent = total3h.toLocaleString();
        document.getElementById('calc-final-2h').textContent = final2h.toLocaleString();
        document.getElementById('calc-final-3h').textContent = final3h.toLocaleString();
    }

    function saveSettings() {
        const idsToSave = [
            'period-input', 'fullhit-discount', 'expense-data',
            'mon_venue', 'mon_total', 'mon_off', 'mon_drop', 'mon_sea', 'mon_note',
            'tue2_venue', 'tue2_total', 'tue2_off', 'tue2_drop', 'tue2_sea', 'tue2_note',
            'tue3_venue', 'tue3_total', 'tue3_off', 'tue3_drop', 'tue3_sea', 'tue3_note',
            'thu_venue', 'thu_total', 'thu_off', 'thu_drop', 'thu_sea', 'thu_note',
            'sat_venue', 'sat_total', 'sat_off', 'sat_drop', 'sat_note'
        ];
        const data = {};
        idsToSave.forEach(id => {
            const el = document.getElementById(id);
            if(el) data[id] = el.value;
        });
        localStorage.setItem('badmintonPlanData', JSON.stringify(data));
        alert('âœ… è¨­å®šå·²å„²å­˜ï¼ä¸‹æ¬¡æ‰“é–‹ç¶²é å°‡è‡ªå‹•è¼‰å…¥ã€‚');
    }

    function loadSettings() {
        const savedData = localStorage.getItem('badmintonPlanData');
        if (savedData) {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const el = document.getElementById(key);
                if (el) el.value = data[key];
            }
        }
        calculateFullHitCost();
    }

    function generateTable() {
        const periodText = document.getElementById('period-input').value;
        document.getElementById('table-title').textContent = `${periodText} å­£æ‰“è²»ç”¨åŠå„ªæƒ æ–¹æ¡ˆ`;
        const fullHitVal = parseInt(document.getElementById('fullhit-discount').value) || 0;
        const tbody = document.getElementById('result-body');
        const tfoot = document.getElementById('result-foot');
        tbody.innerHTML = '';
        tfoot.innerHTML = '';

        const inputs = [
            { id: 'mon', name: 'é€±ä¸€', time: '20:30-22:30', hrs: '2å°æ™‚', color: '#FCE4EC', weekDay: 'ä¸€' }, 
            { id: 'tue2', name: 'é€±äºŒ (2h)', time: '20:30-22:30', hrs: '2å°æ™‚', color: '#eef7e6', weekDay: 'äºŒ' }, 
            { id: 'tue3', name: 'é€±äºŒ (3h)', time: '20:30-23:30', hrs: '3å°æ™‚', color: '#eef7e6', weekDay: 'äºŒ' },
            { id: 'thu', name: 'é€±å››', time: '20:30-23:30', hrs: '3å°æ™‚', color: '#B3E5FC', weekDay: 'å››' },
            { id: 'sat', name: 'é€±å…­', time: '14:00-18:00', hrs: '4å°æ™‚', color: '#FFF3E0', weekDay: 'å…­' }
        ];

        let offDaysSummary = [];
        let allOffDates = [];
        let idx = 1;

        inputs.forEach(row => {
            const total = parseInt(document.getElementById(`${row.id}_total`).value) || 0;
            const drop = parseInt(document.getElementById(`${row.id}_drop`).value) || 0;
            const seaPerVal = document.getElementById(`${row.id}_sea`).value;
            const seaPer = parseInt(seaPerVal) || 0;
            const off = document.getElementById(`${row.id}_off`).value;
            let note = document.getElementById(`${row.id}_note`).value;

            if (note.includes('è«‹å‡ä¸é€€è²»')) {
                note = `<span style="color: red; font-weight: bold;">${note}</span>`;
            }

            if (off.trim() !== '') {
                offDaysSummary.push({ name: row.name.split(' ')[0], weekDay: row.weekDay, date: off });
                const dates = off.match(/(\d+[\/.]\d+)/g);
                if (dates) { allOffDates.push(...dates.map(d => d.replace('.', '/'))); }
            }

            let originalTotal = total * drop;
            let seasonTotal = '-';
            let discount = '-';
            let seaPerDisplay = seaPer;

            if (seaPer === 0) {
                seaPerDisplay = '-';
                originalTotal = '-'; 
            } else {
                seasonTotal = (total * seaPer).toLocaleString();
                originalTotal = originalTotal.toLocaleString();
                const rawOriginal = total * drop;
                const rawSeason = total * seaPer;
                discount = rawOriginal > 0 ? Math.round((rawSeason / rawOriginal) * 100) + 'æŠ˜' : '-';
            }

            const tr = document.createElement('tr');
            tr.style.backgroundColor = row.color; 
            
            let middleSection = '';
            if (row.id === 'sat') {
                middleSection = `<td colspan="4" class="text-center">${off}</td>`; 
            } else {
                middleSection = `
                    <td class="text-center nowrap-header">${off}</td>
                    <td class="text-center">${drop}</td>
                    <td class="text-center">${originalTotal}</td>
                    <td class="text-center">${seaPerDisplay}</td>
                `;
            }

            tr.innerHTML = `
                <td class="text-center">${idx++}</td>
                <td class="text-center">${row.name}</td>
                <td class="text-center">${row.time}</td>
                <td class="text-center">${row.hrs}</td>
                <td class="text-center">${total}</td>
                ${middleSection}
                <td class="text-center">${seasonTotal}</td>
                <td class="text-center">${discount}</td>
                <td class="text-center">${note}</td>
            `;
            tbody.appendChild(tr);
        });

        const dayOrder = ['ä¸€', 'äºŒ', 'å››', 'å…­'];
        let offDaysHTML = '<ul>';
        dayOrder.forEach(day => {
            const entries = offDaysSummary.filter(item => item.weekDay === day);
            const uniqueDates = [...new Set(entries.map(item => item.date))];
            const dateStr = uniqueDates.join('ã€');
            if(dateStr) { offDaysHTML += `<li>é€±${day}ï¼š${dateStr}</li>`; }
        });
        offDaysHTML += '</ul>';

        const totalColumns = 12;
        const leftSpacerColspan = 6; 
        const rightBoxColspan = 6; 

        const footHTML = `
            <tr style="height: 20px;">
                <td colspan="${totalColumns}" style="border:none; background: #fff;"></td>
            </tr>
            <tr>
                <td rowspan="4" colspan="${leftSpacerColspan}" class="left-info-box off-date-box">
                    <span class="box-title title-pink off-date-title">${periodText} ä¸é–‹åœ˜æ—¥æœŸ</span>
                    <div class="off-date-content">${offDaysHTML}</div>
                </td>
                <td colspan="${rightBoxColspan}" class="right-info-box-header combo-header">
                    <span class="box-title title-orange">çµ„åˆå„ªæƒ </span>
                </td>
            </tr>
            <tr>
                <td colspan="${rightBoxColspan}" class="right-info-box-body">
                    <div class="combo-row">
                        <span>2 å€‹ä»»æ„çµ„åˆ</span>
                        <span>- 200</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="${rightBoxColspan}" class="right-info-box-body">
                    <div class="combo-row">
                        <span>å…¨å£˜æ‰“å„ªæƒ  (é€±ä¸€ï¼‹é€±äºŒï¼‹é€±å››)</span>
                        <span>- ${fullHitVal}</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="${rightBoxColspan}" class="right-info-box-footer">
                    <div class="combo-row" style="margin-bottom:0;">
                        <span>åœ¨å­¸å­¸ç”Ÿå„ªæƒ  (å¯èˆ‡ä¸Šè¿°å„ªæƒ åˆä½µä½¿ç”¨)</span>
                        <span>- 100</span>
                    </div>
                </td>
            </tr>
            <tr style="height: 40px;">
                <td colspan="${totalColumns}" style="border:none; background: #fff;"></td>
            </tr>
        `;
        tfoot.innerHTML = footHTML;
        document.getElementById('output-area').style.display = 'block';

        generateCalendar(allOffDates);
    }

    function generateCalendar(userOffDates) {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        document.getElementById('calendar-area').style.display = 'block';
        const year = 2026;
        const months = [0, 1, 2]; 
        const holidays = ["1/1", "2/16", "2/17", "2/18", "2/19", "2/20", "2/28"];
        const playDays = [1, 2, 4, 6]; 
        months.forEach(month => {
            const date = new Date(year, month, 1);
            const monthName = date.toLocaleString('default', { month: 'long' });
            const card = document.createElement('div');
            card.className = 'month-card';
            let tableHtml = `<div class="month-title">${monthName}</div><table class="cal-table">
                <thead><tr><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr></thead><tbody><tr>`;
            let startDay = (date.getDay() + 6) % 7;
            for (let i = 0; i < startDay; i++) { tableHtml += `<td></td>`; }
            while (date.getMonth() === month) {
                const day = date.getDay();
                const adjustedDay = (day + 6) % 7;
                const dateNum = date.getDate();
                const dateStr = `${month + 1}/${dateNum}`;
                let cssClass = '';
                if (userOffDates.includes(dateStr)) { cssClass = 'day-off'; } 
                else if (holidays.includes(dateStr)) { cssClass = 'day-holiday'; } 
                else if (playDays.includes(day)) { cssClass = 'day-play'; }
                tableHtml += `<td><div class="${cssClass}">${dateNum}</div></td>`;
                if (adjustedDay === 6) tableHtml += `</tr><tr>`;
                date.setDate(dateNum + 1);
            }
            tableHtml += `</tr></tbody></table>`;
            card.innerHTML = tableHtml;
            grid.appendChild(card);
        });
    }

    function analyzeData() {
        const text = document.getElementById('expense-data').value.trim();
        const lines = text.split('\n');
        let income = { season: 0, mon: 0, tue: 0, thu: 0, sat: 0, other: 0 };
        let expense = { venue: 0, ball: 0, other: 0 };
        let hc = { 'é€±ä¸€': 0, 'é€±äºŒ 2h': 0, 'é€±äºŒ 3h': 0, 'é€±å››': 0, 'é€±å…­ 2h': 0, 'é€±å…­ 3h': 0, 'é€±å…­ 4h': 0 };
        lines.forEach(line => {
            const parts = line.split(/\s+/);
            if (parts.length < 2) return;
            const amtStr = parts[1].replace(/,/g, '');
            const amount = parseFloat(amtStr);
            if (isNaN(amount)) return;
            const desc = parts.slice(2).join(' '); 
            if (amount > 0) {
                if (desc.includes('å­£æ‰“')) income.season += amount;
                else if (desc.includes('é€±ä¸€')) income.mon += amount;
                else if (desc.includes('é€±äºŒ')) income.tue += amount;
                else if (desc.includes('é€±å››')) income.thu += amount;
                else if (desc.includes('é€±å…­')) income.sat += amount;
                else income.other += amount;
                const match = desc.match(/(\d+)äºº/);
                if (match) {
                    const count = parseInt(match[1]);
                    if (desc.includes('é€±ä¸€')) hc['é€±ä¸€'] += count;
                    else if (desc.includes('é€±å››')) hc['é€±å››'] += count;
                    else if (desc.includes('é€±äºŒ')) {
                        if (desc.includes('2å°æ™‚')) hc['é€±äºŒ 2h'] += count; else hc['é€±äºŒ 3h'] += count;
                    }
                    else if (desc.includes('é€±å…­')) {
                        if (desc.includes('4å°æ™‚')) hc['é€±å…­ 4h'] += count; else if (desc.includes('2å°æ™‚')) hc['é€±å…­ 2h'] += count; else hc['é€±å…­ 3h'] += count;
                    }
                }
            } else {
                const absAmt = Math.abs(amount);
                if (desc.includes('å ´åœ°')) expense.venue += absAmt;
                else if (desc.includes('ç¾½æ¯›çƒ') || desc.includes('ACE') || desc.includes('å‹åˆ©') || desc.includes('çƒéŒ¢')) expense.ball += absAmt;
                else expense.other += absAmt;
            }
        });
        const totalInc = Object.values(income).reduce((a,b)=>a+b,0);
        const totalExp = Object.values(expense).reduce((a,b)=>a+b,0);
        const net = totalInc - totalExp;
        const totalHc = Object.values(hc).reduce((a,b)=>a+b,0);
        document.getElementById('val-inc').textContent = totalInc.toLocaleString();
        document.getElementById('val-exp').textContent = '-' + totalExp.toLocaleString();
        const netEl = document.getElementById('val-net');
        netEl.textContent = net.toLocaleString();
        netEl.className = 'stat-value ' + (net >= 0 ? 'pos' : 'neg');
        document.getElementById('val-hc').textContent = totalHc.toLocaleString() + ' äººæ¬¡';
        let advice = "";
        if (net > 30000) advice = "ğŸ‰ **æœ¬å­£ç‡Ÿé‹ç‹€æ³æ¥µä½³ï¼** ç›ˆé¤˜ç›¸ç•¶å……è£•ï¼Œå»ºè­°å¯è€ƒæ…®å›é¥‹çƒå‹ï¼ˆèˆ‰è¾¦æ¯”è³½æˆ–èšé¤ï¼‰ï¼Œæˆ–é è³¼ä¸‹ä¸€å­£ç¾½çƒä»¥é–å®šæˆæœ¬ã€‚";
        else if (net > 0) advice = "âœ… **æœ¬å­£ç‡Ÿé‹ç‹€æ³ç©©å¥ã€‚** æ”¶æ”¯å¹³è¡¡ä¸”ç•¥æœ‰ç›ˆé¤˜ï¼Œè«‹æŒçºŒç¶­æŒé›¶æ‰“äººæ•¸çš„ç©©å®šæ€§ã€‚";
        else if (net > -20000) advice = "âš ï¸ **æœ¬å­£å‡ºç¾å°å¹…è™§æã€‚** å»ºè­°æª¢è¦–é›œé …æ”¯å‡ºï¼Œä¸¦åŠ å¼·æ¨å»£ç‰¹å®šå†·é–€æ™‚æ®µçš„é›¶æ‰“å ±åã€‚";
        else advice = "ğŸš¨ **æœ¬å­£é¢è‡¨è™§æå£“åŠ›ï¼** å»ºè­°æª¢è¨å­£æ‰“/é›¶æ‰“å®šåƒ¹ç­–ç•¥ï¼Œæˆ–åš´æ ¼æ§ç®¡ç”¨çƒèˆ‡å ´åœ°ç§Ÿç”¨æ™‚æ•¸ã€‚";
        document.getElementById('ai-verdict-text').innerHTML = advice;
        document.getElementById('analysis-dashboard').style.display = 'block';
        renderCharts(expense, income, hc);
    }

    function renderCharts(expense, income, hc) {
        ['chart-expense', 'chart-income', 'chart-headcount'].forEach(id => {
            if (charts[id]) { charts[id].destroy(); }
        });

        const pieOpts = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 12 } },
                datalabels: {
                    display: function(context) {
                        const value = context.dataset.data[context.dataIndex];
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        return (value * 100 / total) > 1.5; 
                    },
                    color: '#333',
                    font: { weight: 'bold', size: 11 },
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderRadius: 4,
                    padding: 4,
                    anchor: 'center',
                    align: 'center',
                    formatter: (value, ctx) => {
                        const label = ctx.chart.data.labels[ctx.dataIndex];
                        const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        const pct = (value * 100 / total).toFixed(1);
                        return `${label}\n$${value.toLocaleString()} (${pct}%)`;
                    }
                },
                tooltip: { enabled: true }
            },
            layout: { padding: 20 }
        };

        charts['chart-expense'] = new Chart(document.getElementById('chart-expense'), {
            type: 'pie',
            data: {
                labels: ['å ´åœ°è²»', 'çƒè²»', 'é›œé …'],
                datasets: [{ 
                    data: [expense.venue, expense.ball, expense.other], 
                    backgroundColor: ['#B3E5FC', '#E8F5E9', '#F5F5F5'], 
                    borderColor: '#ccc', borderWidth: 1 
                }]
            },
            options: pieOpts
        });

        charts['chart-income'] = new Chart(document.getElementById('chart-income'), {
            type: 'pie',
            data: {
                labels: ['å­£æ‰“', 'é€±ä¸€', 'é€±äºŒ', 'é€±å››', 'é€±å…­', 'å…¶ä»–'],
                datasets: [{ 
                    data: [income.season, income.mon, income.tue, income.thu, income.sat, income.other], 
                    backgroundColor: ['#FFC107', '#FCE4EC', '#E8F5E9', '#B3E5FC', '#FFF3E0', '#9E9E9E'], 
                    borderColor: '#ccc', borderWidth: 1 
                }]
            },
            options: pieOpts
        });

        charts['chart-headcount'] = new Chart(document.getElementById('chart-headcount'), {
            type: 'bar',
            data: {
                labels: ['é€±ä¸€', 'é€±äºŒ', 'é€±å››', 'é€±å…­'],
                datasets: [
                    { label: 'é€±ä¸€ (2h)', data: [hc['é€±ä¸€'], 0, 0, 0], backgroundColor: '#66BB6A', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±å›› (3h)', data: [0, 0, hc['é€±å››'], 0], backgroundColor: '#4FC3FF', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±å…­ (4h)', data: [0, 0, 0, hc['é€±å…­ 4h']], backgroundColor: '#E65100', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±å…­ (3h)', data: [0, 0, 0, hc['é€±å…­ 3h']], backgroundColor: '#FF9800', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±å…­ (2h)', data: [0, 0, 0, hc['é€±å…­ 2h']], backgroundColor: '#FFB74D', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±äºŒ (3h)', data: [0, hc['é€±äºŒ 3h'], 0, 0], backgroundColor: '#81C784', stack: 'main', borderColor: 'white', borderWidth: 2 },
                    { label: 'é€±äºŒ (2h)', data: [0, hc['é€±äºŒ 2h'], 0, 0], backgroundColor: '#A5D6A7', stack: 'main', borderColor: 'white', borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, position: 'bottom',
                        labels: { boxWidth: 12, padding: 15, filter: (item) => !item.text.includes('é€±å…­ (3h)') && !item.text.includes('é€±å…­ (2h)') }
                    }, 
                    datalabels: { 
                        color: '#111', font: { weight: 'bold', size: 11 }, 
                        formatter: v => v > 0 ? v : '', 
                        anchor: 'center', align: 'center',
                        backgroundColor: 'rgba(255, 255, 255, 0.7)',
                        borderRadius: 3, padding: 4
                    }
                },
                scales: { 
                    x: { 
                        stacked: true,
                        grid: { display: false, drawOnChartArea: false, drawTicks: false, color: 'transparent', borderColor: 'transparent', tickColor: 'transparent', borderWidth: 0 },
                        border: { display: false },
                        ticks: { font: { size: 14, weight: 'bold' }, color: '#333' }
                    }, 
                    y: { 
                        stacked: true, beginAtZero: true,
                        title: { display: true, text: 'ç¸½äººæ¬¡' }
                    } 
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        setupInputListeners();
        generateTable();
    });
</script>

</body>
</html>
